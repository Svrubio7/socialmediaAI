# =============================================================================
# Staging Deployment Workflow
# Deploys to staging environment on push to develop branch
# =============================================================================

name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:  # Allow manual triggers

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Run CI checks first
  # ===========================================================================
  ci-check:
    name: CI Check
    uses: ./.github/workflows/ci.yml

  # ===========================================================================
  # Deploy to Render Staging
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: ci-check
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend to Render
        if: vars.RENDER_BACKEND_STAGING_HOOK_URL != ''
        run: |
          curl -X POST "${{ vars.RENDER_BACKEND_STAGING_HOOK_URL }}" \
            -H "Accept: application/json" \
            -d ''
        continue-on-error: true

      - name: Deploy Frontend to Render
        if: vars.RENDER_FRONTEND_STAGING_HOOK_URL != ''
        run: |
          curl -X POST "${{ vars.RENDER_FRONTEND_STAGING_HOOK_URL }}" \
            -H "Accept: application/json" \
            -d ''
        continue-on-error: true

      - name: Deploy Worker to Render
        if: vars.RENDER_WORKER_STAGING_HOOK_URL != ''
        run: |
          curl -X POST "${{ vars.RENDER_WORKER_STAGING_HOOK_URL }}" \
            -H "Accept: application/json" \
            -d ''
        continue-on-error: true

      - name: Wait for deployments
        run: |
          echo "Waiting 60 seconds for deployments to start..."
          sleep 60

      - name: Notify deployment started
        run: |
          echo "## Staging Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment to staging environment has been triggered." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-deployment smoke tests
  # ===========================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: vars.STAGING_BACKEND_URL != ''

    steps:
      - name: Wait for deployment to complete
        run: |
          echo "Waiting 120 seconds for deployment to complete..."
          sleep 120

      - name: Health check - Backend
        run: |
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts"
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.STAGING_BACKEND_URL }}/health" || echo "000")
            if [ "$response" == "200" ]; then
              echo "Backend health check passed!"
              exit 0
            fi
            echo "Health check returned: $response"
            sleep 15
            attempt=$((attempt + 1))
          done
          echo "Backend health check failed after $max_attempts attempts"
          exit 1

      - name: Health check - Frontend
        if: vars.STAGING_FRONTEND_URL != ''
        run: |
          max_attempts=10
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts"
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.STAGING_FRONTEND_URL }}" || echo "000")
            if [ "$response" == "200" ]; then
              echo "Frontend health check passed!"
              exit 0
            fi
            echo "Health check returned: $response"
            sleep 15
            attempt=$((attempt + 1))
          done
          echo "Frontend health check failed after $max_attempts attempts"
          exit 1

      - name: Smoke test summary
        if: always()
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ job.status == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ job.status == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
