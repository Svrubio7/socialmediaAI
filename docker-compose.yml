services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NUXT_PUBLIC_API_URL: ${NUXT_PUBLIC_API_URL:-/api/v1}
        NUXT_PUBLIC_SUPABASE_URL: ${NUXT_PUBLIC_SUPABASE_URL:-}
        NUXT_PUBLIC_SUPABASE_ANON_KEY: ${NUXT_PUBLIC_SUPABASE_ANON_KEY:-}
        NUXT_PUBLIC_SUPABASE_STORAGE_BUCKET: ${NUXT_PUBLIC_SUPABASE_STORAGE_BUCKET:-videos}
        NUXT_PUBLIC_EDITOR_PARITY_FLAG: ${NUXT_PUBLIC_EDITOR_PARITY_FLAG:-false}
        NUXT_PUBLIC_EDITOR_FORK_ENABLED: ${NUXT_PUBLIC_EDITOR_FORK_ENABLED:-true}
        NUXT_PUBLIC_EDITOR_FORK_ROLLOUT_PERCENT: ${NUXT_PUBLIC_EDITOR_FORK_ROLLOUT_PERCENT:-100}
        NUXT_PUBLIC_EDITOR_FORK_ALLOWLIST: ${NUXT_PUBLIC_EDITOR_FORK_ALLOWLIST:-}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL:-http://localhost:3000}
        NEXT_PUBLIC_FASTAPI_URL: ${NEXT_PUBLIC_FASTAPI_URL:-/api/v1}
        NEXT_PUBLIC_SUPABASE_URL: ${NUXT_PUBLIC_SUPABASE_URL:-}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NUXT_PUBLIC_SUPABASE_ANON_KEY:-}
        NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET: ${NUXT_PUBLIC_SUPABASE_STORAGE_BUCKET:-videos}
        NEXT_PUBLIC_EDITOR_BASE_PATH: /editor
        NEXT_PUBLIC_EDITOR_RETURN_TO: /editor
        NEXT_PUBLIC_EDITOR_DIAGNOSTICS: ${NEXT_PUBLIC_EDITOR_DIAGNOSTICS:-false}
    env_file:
      - backend/.env
      - frontend/.env
    environment:
      APP_PORT: 3000
      NUXT_PORT: 3001
      OPENCUT_PORT: 3002
      FASTAPI_PORT: 8000
      NUXT_PUBLIC_API_URL: ${NUXT_PUBLIC_API_URL:-/api/v1}
      NEXT_PUBLIC_FASTAPI_URL: ${NEXT_PUBLIC_FASTAPI_URL:-/api/v1}
      NEXT_PUBLIC_EDITOR_BASE_PATH: /editor
      NEXT_PUBLIC_EDITOR_RETURN_TO: /editor
      NEXT_PUBLIC_EDITOR_DIAGNOSTICS: ${NEXT_PUBLIC_EDITOR_DIAGNOSTICS:-false}
      NEXT_PUBLIC_SUPABASE_URL: ${NUXT_PUBLIC_SUPABASE_URL:-}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NUXT_PUBLIC_SUPABASE_ANON_KEY:-}
      NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET: ${NUXT_PUBLIC_SUPABASE_STORAGE_BUCKET:-videos}
      STORAGE_PUBLIC_BASE_URL: ${STORAGE_PUBLIC_BASE_URL:-http://localhost:3000}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
      CORS_ORIGIN_REGEX: ${CORS_ORIGIN_REGEX:-}
    ports:
      - "3000:3000"
    volumes:
      - backend-temp:/srv/backend/temp
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3000/api/health >/dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  backend-temp:
